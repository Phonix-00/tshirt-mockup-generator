from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.shortcuts import get_object_or_404
from .models import MockupTask, MockupImage
from .serializers import (
    MockupTaskSerializer,
    MockupImageSerializer,
    GenerateInputSerializer
)
from .tasks import generate_tshirt_mockup
import logging

# ØªÙ†Ø¸ÛŒÙ… logger
logger = logging.getLogger(__name__)


class GenerateMockupView(APIView):
    """
    API 1: ØªÙˆÙ„ÛŒØ¯ Ù…ÙˆÚ©Ø§Ù¾ Ø¬Ø¯ÛŒØ¯

    POST /api/v1/mockups/generate/

    Body:
    {
        "text": "Hello World"
    }

    Response:
    {
        "task_id": "uuid-string",
        "status": "PENDING",
        "message": "Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ø¢ØºØ§Ø² Ø´Ø¯"
    }
    """

    def post(self, request):
        """
        Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø´Ø±ÙˆØ¹ ØªÙˆÙ„ÛŒØ¯ Ù…ÙˆÚ©Ø§Ù¾ Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
        """
        logger.info("ğŸ“¨ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ù…ÙˆÚ©Ø§Ù¾ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 1: Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙˆØ±ÙˆØ¯ÛŒ
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        serializer = GenerateInputSerializer(data=request.data)

        if not serializer.is_valid():
            logger.warning(f"âš ï¸ ÙˆØ±ÙˆØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±: {serializer.errors}")
            return Response(
                {
                    'error': 'ÙˆØ±ÙˆØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±',
                    'details': serializer.errors
                },
                status=status.HTTP_400_BAD_REQUEST
            )

        # Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† ØªÙ…ÛŒØ² Ø´Ø¯Ù‡
        text = serializer.validated_data['text']
        logger.info(f"âœ… Ù…ØªÙ† Ø¯Ø±ÛŒØ§ÙØªÛŒ: {text}")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 2: Ø³Ø§Ø®Øª task Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        try:
            task = MockupTask.objects.create(
                text=text,
                status='PENDING'
            )
            logger.info(f"âœ… Task Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯: {task.task_id}")
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª task: {str(e)}")
            return Response(
                {
                    'error': 'Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª task',
                    'details': str(e)
                },
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 3: ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Celery task (Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        try:
            # Ø§Ø±Ø³Ø§Ù„ ØªØ³Ú© Ø¨Ù‡ Celery
            celery_task = generate_tshirt_mockup.delay(
                str(task.task_id),
                text
            )
            logger.info(f"ğŸš€ ØªØ³Ú© Celery Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: {celery_task.id}")
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Celery: {str(e)}")
            # ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ FAILURE
            task.status = 'FAILURE'
            task.save()
            return Response(
                {
                    'error': 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Celery',
                    'details': str(e)
                },
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 4: Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        logger.info(f"âœ… Ù¾Ø§Ø³Ø® Ù…ÙˆÙÙ‚ Ø¨Ø±Ø§ÛŒ task: {task.task_id}")

        return Response(
            {
                'task_id': str(task.task_id),
                'status': 'PENDING',
                'message': 'Ø³Ø§Ø®Øª ØªØµÙˆÛŒØ± Ø¢ØºØ§Ø² Ø´Ø¯'
            },
            status=status.HTTP_202_ACCEPTED  # 202 = Accepted
        )


class TaskStatusView(APIView):
    """
    API 2: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ÛŒÚ© task

    GET /api/v1/tasks/{task_id}/

    Response:
    {
        "task_id": "uuid-string",
        "status": "SUCCESS",
        "results": [
            {
                "id": 1,
                "shirt_color": "black",
                "image_url": "http://...",
                "created_at": "..."
            },
            ...
        ]
    }
    """

    def get(self, request, task_id):
        """
        Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ÛŒÚ© task Ùˆ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† ØªØµØ§ÙˆÛŒØ± Ø¯Ø± ØµÙˆØ±Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø¨ÙˆØ¯Ù†
        """
        logger.info(f"ğŸ” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª task: {task_id}")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 1: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† task Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        task = get_object_or_404(MockupTask, task_id=task_id)
        logger.info(f"âœ… Task Ù¾ÛŒØ¯Ø§ Ø´Ø¯ - ÙˆØ¶Ø¹ÛŒØª: {task.status}")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 2: Ø¯Ø±ÛŒØ§ÙØª ØªØµØ§ÙˆÛŒØ± Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† task
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        images = task.images.all()
        logger.info(f"ğŸ“¸ ØªØ¹Ø¯Ø§Ø¯ ØªØµØ§ÙˆÛŒØ±: {images.count()}")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 3: Ø³Ø±ÛŒØ§Ù„Ø§ÛŒØ² Ú©Ø±Ø¯Ù† ØªØµØ§ÙˆÛŒØ±
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        image_serializer = MockupImageSerializer(
            images,
            many=True,
            context={'request': request}
        )

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 4: Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù¾Ø§Ø³Ø®
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        response_data = {
            'task_id': str(task.task_id),
            'status': task.status,
            'results': image_serializer.data
        }

        logger.info(f"âœ… Ù¾Ø§Ø³Ø® Ù…ÙˆÙÙ‚ Ø¨Ø±Ø§ÛŒ task: {task_id}")

        return Response(response_data, status=status.HTTP_200_OK)


class MockupListView(APIView):
    """
    API 3: Ù„ÛŒØ³Øª ØªÙ…Ø§Ù… Ù…ÙˆÚ©Ø§Ù¾â€ŒÙ‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡

    GET /api/mockups/

    Response:
    {
        "results": [
            {
                "id": 1,
                "text": "Hello World",
                "image_url": "http://...",
                "shirt_color": "black",
                "created_at": "..."
            },
            ...
        ]
    }
    """

    def get(self, request):
        """
        Ù„ÛŒØ³Øª ØªÙ…Ø§Ù… ØªØµØ§ÙˆÛŒØ± Ù…ÙˆÚ©Ø§Ù¾ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡
        """
        logger.info("ğŸ“‹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù„ÛŒØ³Øª Ù…ÙˆÚ©Ø§Ù¾â€ŒÙ‡Ø§")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 1: Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ù… ØªØµØ§ÙˆÛŒØ±
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² select_related Ø¨Ø±Ø§ÛŒ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ query
        images = MockupImage.objects.select_related('task').all()
        logger.info(f"âœ… ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØªØµØ§ÙˆÛŒØ±: {images.count()}")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 2: Ø³Ø§Ø®Øª Ù„ÛŒØ³Øª Ù†ØªØ§ÛŒØ¬
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        results = []

        for img in images:
            # Ø³Ø§Ø®Øª URL Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ ØªØµÙˆÛŒØ±
            image_url = None
            if img.image:
                image_url = request.build_absolute_uri(img.image.url)

            # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª
            results.append({
                'id': img.id,
                'text': img.task.text,
                'image_url': image_url,
                'shirt_color': img.shirt_color,
                'created_at': img.created_at
            })

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 3: Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù¾Ø§Ø³Ø®
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        logger.info(f"âœ… Ù„ÛŒØ³Øª Ù…ÙˆÚ©Ø§Ù¾â€ŒÙ‡Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ø´Ø¯")

        return Response(
            {'results': results},
            status=status.HTTP_200_OK
        )