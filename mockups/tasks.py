from celery import shared_task
from PIL import Image, ImageDraw, ImageFont
from django.conf import settings
from .models import MockupTask, MockupImage
import os
import logging

# ØªÙ†Ø¸ÛŒÙ… logger Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
logger = logging.getLogger(__name__)


@shared_task(bind=True)
def generate_tshirt_mockup(self, task_id_str, text):
    """
    ØªØ³Ú© Ø§ØµÙ„ÛŒ Celery Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ù…ÙˆÚ©Ø§Ù¾ ØªÛŒØ´Ø±Øª

    Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´Ù‡ Ùˆ 4 ØªØµÙˆÛŒØ± ØªÛŒØ´Ø±Øª Ø¨Ø§ Ù…ØªÙ† Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØ³Ø§Ø²Ù‡

    Args:
        task_id_str (str): UUID ØªØ³Ú© Ø¨Ù‡ ØµÙˆØ±Øª string
        text (str): Ù…ØªÙ† Ú©Ø§Ø±Ø¨Ø± Ú©Ù‡ Ø±ÙˆÛŒ ØªÛŒØ´Ø±Øª Ú†Ø§Ù¾ Ù…ÛŒâ€ŒØ´Ù‡

    Returns:
        dict: Ù†ØªÛŒØ¬Ù‡ ØªØ³Ú© (Ù…ÙˆÙÙ‚ ÛŒØ§ Ø®Ø·Ø§)
    """

    logger.info(f"ğŸš€ Ø´Ø±ÙˆØ¹ ØªÙˆÙ„ÛŒØ¯ Ù…ÙˆÚ©Ø§Ù¾ Ø¨Ø±Ø§ÛŒ task: {task_id_str}")

    try:
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 1: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªØ³Ú© Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        task = MockupTask.objects.get(task_id=task_id_str)
        task.status = 'PROCESSING'
        task.save()
        logger.info(f"âœ… Task Ù¾ÛŒØ¯Ø§ Ø´Ø¯ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ PROCESSING ØªØºÛŒÛŒØ± Ú©Ø±Ø¯")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 2: Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ ØªÛŒØ´Ø±Øª
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        colors = ['black', 'white', 'blue', 'yellow']
        logger.info(f"ğŸ“‹ Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²: {colors}")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 3: Ù…Ø³ÛŒØ± ØªØµØ§ÙˆÛŒØ± ØªÛŒØ´Ø±Øª Ø§ØµÙ„ÛŒ
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        tshirt_base_path = os.path.join(settings.BASE_DIR, 'mockups', 'tshirts')
        logger.info(f"ğŸ“ Ù…Ø³ÛŒØ± ØªØµØ§ÙˆÛŒØ±: {tshirt_base_path}")

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù¾ÙˆØ´Ù‡
        if not os.path.exists(tshirt_base_path):
            raise Exception(f"Ù¾ÙˆØ´Ù‡ ØªØµØ§ÙˆÛŒØ± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯: {tshirt_base_path}")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 4: ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±Ù†Ú¯
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        generated_images = []

        for color in colors:
            logger.info(f"ğŸ¨ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ ØªÛŒØ´Ø±Øª {color}...")

            # Ù…Ø³ÛŒØ± ØªØµÙˆÛŒØ± ØªÛŒØ´Ø±Øª Ø§ØµÙ„ÛŒ
            tshirt_image_path = os.path.join(tshirt_base_path, f'{color}.png')

            # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„
            if not os.path.exists(tshirt_image_path):
                logger.warning(f"âš ï¸ ÙØ§ÛŒÙ„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯: {tshirt_image_path}")
                continue

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ø§Ù„Ù) Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ØªØµÙˆÛŒØ± ØªÛŒØ´Ø±Øª
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            img = Image.open(tshirt_image_path).convert('RGBA')
            logger.info(f"âœ… ØªØµÙˆÛŒØ± {color} Ø¨Ø§Ø² Ø´Ø¯ - Ø³Ø§ÛŒØ²: {img.size}")

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ø¨) Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ´ØªÙ† Ù…ØªÙ†
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            draw = ImageDraw.Draw(img)

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ø¬) Ø§Ù†ØªØ®Ø§Ø¨ ÙÙˆÙ†Øª
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            try:
                # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙÙˆÙ†Øª Arial
                font = ImageFont.truetype("arial.ttf", 50)
                logger.info("âœ… ÙÙˆÙ†Øª Arial Ù„ÙˆØ¯ Ø´Ø¯")
            except Exception as e:
                # Ø§Ú¯Ù‡ Arial Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø² ÙÙˆÙ†Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
                font = ImageFont.load_default()
                logger.warning(f"âš ï¸ ÙÙˆÙ†Øª Arial Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø§Ø² default Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯: {e}")

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ø¯) Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…ØªÙ† (ÙˆØ³Ø· ØªØµÙˆÛŒØ±)
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            img_width, img_height = img.size

            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§ÛŒØ² Ù…ØªÙ†
            bbox = draw.textbbox((0, 0), text, font=font)
            text_width = bbox[2] - bbox[0]
            text_height = bbox[3] - bbox[1]

            # Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…ØªÙ† (ÙˆØ³Ø· Ø§ÙÙ‚ÛŒØŒ Ú©Ù…ÛŒ Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² ÙˆØ³Ø· Ø¹Ù…ÙˆØ¯ÛŒ)
            x = (img_width - text_width) // 2
            y = (img_height - text_height) // 2 - 80  # 80 Ù¾ÛŒÚ©Ø³Ù„ Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ù…Ø±Ú©Ø²

            logger.info(f"ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…ØªÙ†: x={x}, y={y}")

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ù‡) Ù†ÙˆØ´ØªÙ† Ù…ØªÙ† Ø±ÙˆÛŒ ØªØµÙˆÛŒØ±
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            text_color = '#FFFFFF'  # Ø³ÙÛŒØ¯ (Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ø±Ù†Ú¯â€ŒÙ‡Ø§)
            draw.text((x, y), text, fill=text_color, font=font)
            logger.info(f"âœ… Ù…ØªÙ† Ù†ÙˆØ´ØªÙ‡ Ø´Ø¯ Ø¨Ø§ Ø±Ù†Ú¯ {text_color}")

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ùˆ) Ø°Ø®ÛŒØ±Ù‡ ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            output_filename = f'mockup_{task_id_str}_{color}.png'
            output_folder = os.path.join(settings.MEDIA_ROOT, 'mockups')

            # Ø³Ø§Ø®Øª Ù¾ÙˆØ´Ù‡ Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯
            os.makedirs(output_folder, exist_ok=True)

            output_path = os.path.join(output_folder, output_filename)
            img.save(output_path, 'PNG')
            logger.info(f"ğŸ’¾ ØªØµÙˆÛŒØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: {output_path}")

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ø²) Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            mockup_image = MockupImage.objects.create(
                task=task,
                shirt_color=color,
                image=f'mockups/{output_filename}'
            )
            generated_images.append(mockup_image)
            logger.info(f"âœ… Ø±Ú©ÙˆØ±Ø¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø±Ø§ÛŒ {color} Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ù‚Ø¯Ù… 5: ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ SUCCESS
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        task.status = 'SUCCESS'
        task.save()
        logger.info(f"ğŸ‰ ØªÙ…Ø§Ù…! Ù‡Ù…Ù‡ ØªØµØ§ÙˆÛŒØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù†Ø¯")

        return {
            'status': 'success',
            'task_id': task_id_str,
            'images_count': len(generated_images),
            'colors': colors
        }

    except MockupTask.DoesNotExist:
        # ØªØ³Ú© Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
        logger.error(f"âŒ Ø®Ø·Ø§: Task Ø¨Ø§ ID {task_id_str} Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯")
        return {
            'status': 'error',
            'message': 'Task not found in database'
        }

    except Exception as e:
        # Ù‡Ø± Ø®Ø·Ø§ÛŒ Ø¯ÛŒÚ¯Ù‡â€ŒØ§ÛŒ
        logger.error(f"âŒ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡: {str(e)}")

        # ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ØªØ³Ú© Ø¨Ù‡ FAILURE
        try:
            task = MockupTask.objects.get(task_id=task_id_str)
            task.status = 'FAILURE'
            task.save()
            logger.info(f"âš ï¸ ÙˆØ¶Ø¹ÛŒØª task Ø¨Ù‡ FAILURE ØªØºÛŒÛŒØ± Ú©Ø±Ø¯")
        except:
            pass

        return {
            'status': 'error',
            'message': str(e)
        }